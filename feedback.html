<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>STEAM Education</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="shortcut icon" href="idara logo.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-dark: #1A144C;
      --primary-accent: #01B7C5;
      --pure-white: #FFFFFF;
      --light-bg: #F8FAFC;
      --text-gray: #6B7280;
    }
    body { font-family: 'Segoe UI', sans-serif; background: var(--light-bg); margin:0; padding:0; color:var(--primary-dark); line-height:1.6; }
    .navbar { display:flex; align-items:center; justify-content:space-between; background-color:var(--primary-dark); padding:12px 30px; }
    .navbar img { height:42px; background:var(--pure-white); padding:4px 6px; border-radius:6px; }
    .nav-links a { color:var(--pure-white); text-decoration:none; font-size:16px; font-weight:500; margin-left:20px; transition:opacity .2s; }
    .nav-links a:hover { opacity:.7; }
    .container { padding:40px 20px; max-width:1300px; margin:0 auto; }
    h1 { font-size:28px; font-weight:700; margin-bottom:8px; }
    p.subtitle { color:var(--text-gray); margin-bottom:25px; font-size:15px; }
    .filters { display:flex; gap:20px; margin-bottom:30px; flex-wrap:wrap; }
    .filters select { padding:8px 12px; font-size:15px; border:1px solid #01B7C5; border-radius:8px; background:var(--pure-white); cursor:pointer; transition:border-color .2s, box-shadow .2s; }
    .filters select:focus { outline:none; border-color:var(--primary-accent); box-shadow:0 0 0 3px rgba(1,183,197,.2); }
    .charts { display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:24px; }
    .chart-card { background:var(--pure-white); border-radius:12px; padding:20px; box-shadow:0 6px 16px rgba(0,0,0,.08); transition:transform .2s ease, box-shadow .2s ease; }
    .chart-card:hover { transform:translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,.12); }
    .chart-card h3 { font-size:17px; margin-bottom:15px; font-weight:600; color:var(--primary-dark); }
    footer { padding:14px; text-align:center; background:var(--primary-dark); color:#e5e7eb; font-size:14px; margin-top:30px; }
  </style>
</head>
<body>
  <nav class="navbar">
    <img src="./idara logo.png" alt="Logo">
    <div class="nav-links" id="navLinks">
      <a href="./index.html">Task Dashboard</a>
      <a href="./curriculum.html">STEAM Curriculum</a>
      <a href="./Inventory.html">Robotics Inventory</a>
      <a href="./feedback.html">Students Feedback</a>
    </div>
  </nav>

  <div class="container">
    <h1>STEAM Education Feedback</h1>
    <p class="subtitle">Interactive charts below show studentsâ€™ reflections on STEAM classes.</p>

    <div class="filters">
      <select id="campusFilter"><option value="">All Campuses</option></select>
      <select id="gradeFilter"><option value="">All Grades</option></select>
      <select id="sectionFilter"><option value="">All Sections</option></select>
    </div>

    <div class="charts">
      <div class="chart-card"><h3>Overall Benefit Distribution</h3><canvas id="benefitChart"></canvas></div>
      <div class="chart-card"><h3>Confidence in Presenting Ideas</h3><canvas id="confidenceChart"></canvas></div>
      <div class="chart-card"><h3>Teacher Guidance Helpfulness</h3><canvas id="teacherChart"></canvas></div>
      <div class="chart-card"><h3>Hands-on Activities Engagement</h3><canvas id="activitiesChart"></canvas></div>
      <div class="chart-card"><h3>Average Percentage (Overall Benefit)</h3><canvas id="averageChart"></canvas></div>
    </div>
  </div>

  <footer>Developed by <strong>STEAM Team</strong>.</footer>

  <script>
    // --- CONFIG (keep your API key / Sheet ID as you had) ---
    const API_KEY = "AIzaSyAiEhYfZwzhH2aq9D0rS-OPFsWONiJdFho";
    const SHEET_ID = "1K3ToADjTUjFg6AMBDbQm0Q57BX5OPxErqkJwo1khzeQ";
    const RANGE = "Form Responses 1";

    let headers = [], rows = [], chartInstances = {};

    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(RANGE)}?key=${API_KEY}`;

    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (!data.values || data.values.length < 2) return;
        headers = data.values[0];
        rows = data.values.slice(1);
        populateFilters();
        applyFilters();
      })
      .catch(err => console.error("Sheet fetch error:", err));

    function populateFilters() {
      const campusIndex = headers.findIndex(h => h.toLowerCase().includes("campus"));
      const gradeIndex = headers.findIndex(h => h.toLowerCase().includes("grade"));
      const sectionIndex = headers.findIndex(h => h.toLowerCase().includes("section"));

      fillDropdown("campusFilter", [...new Set(rows.map(r => r[campusIndex]))]);
      fillDropdown("gradeFilter", [...new Set(rows.map(r => r[gradeIndex]))]);
      fillDropdown("sectionFilter", [...new Set(rows.map(r => r[sectionIndex]))]);

      document.querySelectorAll(".filters select").forEach(sel => sel.addEventListener("change", applyFilters));
    }

    function fillDropdown(id, values) {
      const select = document.getElementById(id);
      values.filter(v => v).forEach(val => {
        const option = document.createElement("option");
        option.value = val;
        option.textContent = val;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      const campusVal = document.getElementById("campusFilter").value;
      const gradeVal = document.getElementById("gradeFilter").value;
      const sectionVal = document.getElementById("sectionFilter").value;

      const campusIndex = headers.findIndex(h => h.toLowerCase().includes("campus"));
      const gradeIndex = headers.findIndex(h => h.toLowerCase().includes("grade"));
      const sectionIndex = headers.findIndex(h => h.toLowerCase().includes("section"));

      const filtered = rows.filter(row => {
        return (!campusVal || row[campusIndex] === campusVal) &&
               (!gradeVal || row[gradeIndex] === gradeVal) &&
               (!sectionVal || row[sectionIndex] === sectionVal);
      });

      updateCharts(filtered);
    }

    // --- robust value parser (handles numbers inside strings and common text labels) ---
    function parseLikertValue(cell) {
      if (cell === undefined || cell === null) return null;
      const s = String(cell).trim();
      if (!s) return null;

      // 1) try to find a number inside the string
      const numMatch = s.match(/-?\d+(\.\d+)?/);
      if (numMatch) {
        return parseFloat(numMatch[0]);
      }

      // 2) fallback mapping for common textual answers
      const t = s.toLowerCase();
      const mapping = {
        "very beneficial": 5,
        "extremely beneficial": 5,
        "very good": 5,
        "beneficial": 4,
        "somewhat beneficial": 4,
        "good": 4,
        "average": 3,
        "neutral": 3,
        "not sure": 3,
        "not beneficial": 2,
        "not at all": 1,
        "not beneficial at all": 1,
        "strongly agree": 5,
        "agree": 4,
        "disagree": 2,
        "strongly disagree": 1,
        "poor": 1,
        "excellent": 5
      };
      for (const key in mapping) {
        if (t.includes(key)) return mapping[key];
      }

      // if nothing matched
      return null;
    }

    // --- Chart center-text plugin for doughnut ---
    const centerTextPlugin = {
      id: 'centerText',
      beforeDraw(chart) {
        if (chart.config.type !== 'doughnut') return;
        const {ctx, data, width, height} = chart;
        const val = (data && data.datasets && data.datasets[0] && data.datasets[0].data && data.datasets[0].data[0]) || 0;
        const text = `${Number(val).toFixed(1)}%`;
        ctx.save();
        ctx.font = '600 20px "Segoe UI", system-ui, -apple-system';
        ctx.fillStyle = '#1A144C';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, width / 2, height / 2);
        ctx.restore();
      }
    };
    // register plugin once
    Chart.register(centerTextPlugin);

    // --- update charts using filtered rows ---
    function updateCharts(filtered) {
      const benefitIndex = headers.findIndex(h => h.toLowerCase().includes("how beneficial"));
      const confidenceIndex = headers.findIndex(h => h.toLowerCase().includes("confident"));
      const teacherIndex = headers.findIndex(h => h.toLowerCase().includes("teacher"));
      const activitiesIndex = headers.findIndex(h => h.toLowerCase().includes("hands-on"));

      function getDistribution(index) {
        const counts = {};
        filtered.forEach(row => {
          let val = (row[index] || "").toString().trim();
          if (!val) return;
          counts[val] = (counts[val] || 0) + 1;
        });
        return counts;
      }

      // render distribution charts (bar)
      renderBarChart("benefitChart", getDistribution(benefitIndex));
      renderBarChart("confidenceChart", getDistribution(confidenceIndex));
      renderBarChart("teacherChart", getDistribution(teacherIndex));
      renderBarChart("activitiesChart", getDistribution(activitiesIndex));

      // --- compute robust average percentage ---
      function getAveragePercentage(index) {
        const parsed = filtered
          .map(r => parseLikertValue(r[index]))
          .filter(v => v !== null && !isNaN(v));

        if (parsed.length === 0) return 0;

        const sum = parsed.reduce((a, b) => a + b, 0);
        const avg = sum / parsed.length;
        const maxVal = Math.max(...parsed);

        // if values look like percentages already (ex: max > 10),
        // we treat incoming numbers as percentages and return average directly
        if (maxVal > 10) {
          return Math.min(100, avg);
        }

        // otherwise treat as Likert scale. assume scale max = Math.max(5, maxVal)
        const scaleMax = Math.max(5, Math.ceil(maxVal));
        const percent = (avg / scaleMax) * 100;
        return Math.min(100, Math.max(0, percent));
      }

      const overallPct = getAveragePercentage(benefitIndex);

      // render donut showing percentage (0 - 100)
      renderPercentageDoughnut("averageChart", overallPct);
    }

    // --- bar chart renderer for distribution charts ---
    function renderBarChart(canvasId, dataObj) {
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

      const labels = Object.keys(dataObj);
      const data = Object.values(dataObj);

      const ctx = document.getElementById(canvasId);
      chartInstances[canvasId] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Responses",
            data,
            backgroundColor: ["#01B7C5", "#28A745", "#007BFF", "#FFC107", "#6C757D", "#DC3545"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const value = context.raw;
                  const percent = total ? ((value / total) * 100).toFixed(1) : "0.0";
                  return `${context.label}: ${value} (${percent}%)`;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // --- doughnut renderer for average percentage ---
    function renderPercentageDoughnut(canvasId, percent) {
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

      const ctx = document.getElementById(canvasId);
      chartInstances[canvasId] = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Average", "Remaining"],
          datasets: [{
            data: [Number(percent.toFixed(1)), Math.max(0, Number((100 - percent).toFixed(1)))],
            backgroundColor: ["#01B7C5", "#E5E7EB"],
            hoverOffset: 6,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          cutout: '68%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw.toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
